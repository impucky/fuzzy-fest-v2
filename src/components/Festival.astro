---
import { Image } from "astro:assets";
import { Icon } from "astro-icon/components";
import Spacer from "./Spacer";
import bandsFile from "../../content/bands.json";

import { formatFestivalDates, formatProvisionalDate } from "../utils/dates";
import { getPastEditions } from "../utils/content";

import type { Festival } from "../content.config";

const festival: Festival = Astro.props.festival;
const bands = bandsFile as Record<string, string>;
const { name, key, website, country, city, indoor, startDate, endDate, lineup, img, provisionalDate } =
  festival;
const year = new Date(startDate).getFullYear();
const sortedLineup = lineup ? lineup.sort((a, b) => bands[a].localeCompare(bands[b])) : null;
const pastEditions = await getPastEditions(key, new Date(startDate));
---

<section class="flex flex-col items-center text-center text-white">
  <a class="sticky top-1 left-0 z-1 ml-auto p-1 lg:p-2" href={`/${year}`}
    ><Icon name="close" class="text-3xl text-neutral-400 transition hover:text-white" /></a
  >
  {
    img && (
      <Image
        src={img}
        alt={name + " logo"}
        class="h-auto max-h-20 w-auto max-w-64 md:max-h-32 lg:max-w-80 xl:max-w-full"
      />
    )
  }
  <h2 class="mt-2 text-lg text-neutral-200">{name}</h2>

  <div class="mt-1 flex items-center gap-1 text-center">
    <Icon name="pin" class="text-xl" />
    <h3 class="text-lg">{city}, {country}</h3>
  </div>

  <div class="flex items-center gap-1 text-center">
    <Icon name="calendar" class="text-xl" />
    <p>{provisionalDate ? formatProvisionalDate(startDate) : formatFestivalDates(startDate, endDate)}</p>
  </div>

  <div class="flex items-center gap-1 text-center">
    <Icon name={indoor ? "building" : "tent"} class="text-xl" />
    <p>{indoor ? "Indoor" : "Open-air"}</p>
  </div>

  <div class="mt-2 flex items-center gap-1 text-center">
    <Icon name="link" class="text-xl" />
    <a
      href={website}
      target="_blank"
      class="cursor-pointer text-lg text-[lightcoral] underline transition hover:text-white"
    >
      homepage
    </a>
  </div>

  <Spacer label="LINEUP" />

  <ul class="flex w-full flex-col flex-wrap pb-4">
    {
      sortedLineup
        ? sortedLineup.map((band: string) => {
            return (
              <li class="text-md leading-snug font-semibold tracking-wide text-neutral-50 md:text-lg">
                {bands[band].toUpperCase()}
              </li>
            );
          })
        : "To be announced"
    }
  </ul>

  {
    pastEditions.length > 0 && (
      <>
        <Spacer label="PAST EDITIONS" />
        <ul class="flex w-full flex-col flex-wrap pb-4">
          {pastEditions.map((f) => {
            const year = new Date(f.startDate).getFullYear();
            return (
              <li>
                <a
                  class="text-md leading-snug font-black text-white transition hover:text-[lightcoral] hover:underline md:text-lg"
                  href={`/${year}/${f.key}`}
                >
                  {f.name} {new Date(f.startDate).getFullYear()}
                </a>
              </li>
            );
          })}
        </ul>
      </>
    )
  }
</section>
